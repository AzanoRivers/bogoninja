---
/**
 * Unsubscribe Page - Página de desuscripción de notificaciones
 * 
 * @description
 * Procesa la desuscripción de usuarios usando token de seguridad.
 * Muestra mensaje de éxito o error según el resultado.
 * 
 * @author AzanoRivers
 * @ai Claude Sonnet 4.5 (GitHub Copilot)
 */

import MainLayout from "@/layout/MainLayout.astro";
import { PulseLogo, Header } from "@/components";
import { processUnsubscribe } from "@/lib/unsubscribe-service";

export const prerender = false; // Esta página necesita SSR para procesar query params

// Obtener query parameters
const url = new URL(Astro.request.url);
const email = url.searchParams.get('email');
const token = url.searchParams.get('token');

let status: 'loading' | 'success' | 'error' = 'loading';
let message = '';

// Si hay email y token, procesar desuscripción
if (email && token) {
    try {
        // Llamar directamente a la función de servicio (sin fetch interno)
        const result = await processUnsubscribe(email, token);

        if (result.success) {
            status = 'success';
            message = result.message || 'Te has desuscrito correctamente de las notificaciones de entrenamiento.';
        } else {
            status = 'error';
            message = result.error || 'Hubo un error al procesar tu solicitud.';
        }
    } catch (error) {
        console.error('Error al procesar desuscripción:', error);
        status = 'error';
        message = 'Error de conexión. Por favor intenta más tarde.';
    }
} else {
    status = 'error';
    message = 'Enlace de desuscripción inválido o incompleto.';
}
---

<MainLayout 
    title="Desuscribirse - Bogotá · Ninja"
    description="Desuscríbete de las notificaciones de entrenamiento de Bogoninja"
    noIndex={true}
>
    <!-- Header Mobile/Tablet -->
    <Header className="xl:hidden" />
    
    <div class="flex flex-col items-center justify-center min-h-[80vh] gap-8 px-6">
        <PulseLogo className="mt-4 w-20! h-20! sm:w-24! sm:h-24! md:w-28! md:h-28! lg:w-32! lg:h-32!" />
        
        <div class="text-center space-y-6 max-w-2xl">
            {status === 'success' ? (
                <>
                    <h1 class="font-joti sm:text-4xl md:text-5xl lg:text-6xl text-ninja-light-pink mystic-shadow-static">
                        Desuscripción Exitosa
                    </h1>
                    
                    <p class="font-lato sm:text-base md:text-lg lg:text-xl text-ninja-white/80 leading-relaxed">
                        {message}
                    </p>
                    
                    <p class="font-lato sm:text-sm md:text-base lg:text-lg text-ninja-white/60 italic">
                        Ya no recibirás notificaciones sobre las próximas sesiones de entrenamiento.
                    </p>
                    
                    <p class="font-lato sm:text-sm md:text-base text-ninja-white/70 mt-4">
                        Si cambias de opinión, puedes registrarte nuevamente en cualquier momento desde la página principal.
                    </p>
                </>
            ) : (
                <>
                    <h1 class="font-joti sm:text-4xl md:text-5xl lg:text-6xl text-ninja-dark-pink mystic-shadow-static">
                        Error al Desuscribirse
                    </h1>
                    
                    <p class="font-lato sm:text-base md:text-lg lg:text-xl text-ninja-white/80 leading-relaxed">
                        {message}
                    </p>
                    
                    <div class="bg-ninja-dark-blue/30 backdrop-blur-sm p-6 rounded-lg border border-ninja-dark-pink/40 mt-6">
                        <p class="font-lato sm:text-sm md:text-base text-ninja-white/80 mb-3">
                            Si necesitas desuscribirte, por favor:
                        </p>
                        <ul class="font-lato sm:text-sm md:text-base text-ninja-white/70 text-left space-y-2">
                            <li>• Intenta nuevamente con el link del email más reciente</li>
                            <li>• Contáctame por <a href="https://t.me/azanorivers" class="text-ninja-light-pink hover:text-ninja-dark-pink underline transition-colors">Telegram</a> para ayudarte</li>
                        </ul>
                    </div>
                </>
            )}
            
            <div class="flex flex-col sm:flex-row gap-4 justify-center mt-8">
                <a 
                    href="/" 
                    class="inline-block font-joti sm:text-lg md:text-xl lg:text-2xl text-ninja-light-pink hover:text-ninja-dark-pink transition-colors duration-300 underline decoration-2 underline-offset-4"
                >
                    Volver al inicio
                </a>
                <a 
                    href="https://t.me/azanorivers" 
                    target="_blank"
                    rel="noopener noreferrer"
                    class="inline-block font-joti sm:text-lg md:text-xl lg:text-2xl text-ninja-dark-pink hover:text-ninja-light-pink transition-colors duration-300 underline decoration-2 underline-offset-4"
                >
                    Contactar por Telegram
                </a>
            </div>
        </div>
    </div>
    
    <!-- Header Desktop -->
    <Header className="hidden xl:block xl:fixed xl:bottom-4 xl:right-4" />
</MainLayout>

<style>
    /* Animación suave de entrada */
    div {
        animation: fadeIn 0.6s ease-out;
    }
    
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
