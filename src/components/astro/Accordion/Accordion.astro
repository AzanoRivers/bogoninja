---
/**
 * Accordion Component - Acordeón/Pestaña desplegable con estilo Bogoninja
 * 
 * Uso:
 * <Accordion title="Título del acordeón">
 *   <p>Contenido HTML normal</p>
 *   <BlockText text="Componente Astro" />
 *   <ContactForm client:load />
 * </Accordion>
 * 
 * Con clases personalizadas:
 * <Accordion title="Más información" className="mt-4" defaultOpen={true}>
 *   Contenido aquí
 * </Accordion>
 * 
 * @author AzanoRivers
 * @ai Claude Sonnet 4.5 (GitHub Copilot)
 */

import './Accordion.css';

interface Props {
    title: string;
    className?: string;
    defaultOpen?: boolean;
}

const { title, className = "", defaultOpen = false } = Astro.props;
// Generar ID único usando crypto (más seguro y sin colisiones)
const accordionId = `accordion-${crypto.randomUUID().slice(0, 8)}`;
---

<div class={`accordion-container ${className}`}>
    <button
        type="button"
        id={`${accordionId}-button`}
        class="accordion-button sm:text-base md:text-xl lg:text-2xl xl:text-3xl"
        aria-expanded={defaultOpen}
        aria-controls={accordionId}
        data-accordion-trigger
    >
        <span class="accordion-title">{title}</span>
        <svg
            class="accordion-icon accordion-icon-down"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
        >
            <path d="M19 9L14 14.1599C13.7429 14.4323 13.4329 14.6493 13.089 14.7976C12.7451 14.9459 12.3745 15.0225 12 15.0225C11.6255 15.0225 11.2549 14.9459 10.9109 14.7976C10.567 14.6493 10.2571 14.4323 10 14.1599L5 9" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <svg
            class="accordion-icon accordion-icon-up"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
        >
            <path d="M5 15L10 9.84985C10.2563 9.57616 10.566 9.35814 10.9101 9.20898C11.2541 9.05983 11.625 8.98291 12 8.98291C12.375 8.98291 12.7459 9.05983 13.0899 9.20898C13.434 9.35814 13.7437 9.57616 14 9.84985L19 15" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
    </button>
    <div
        id={accordionId}
        class={`accordion-content ${defaultOpen ? 'is-open' : ''}`}
        role="region"
        aria-labelledby={`${accordionId}-button`}
        data-accordion-content
    >
        <div class="accordion-content-inner">
            <slot />
        </div>
    </div>
</div>

<script>
    function initAccordions() {
        const triggers = document.querySelectorAll('[data-accordion-trigger]');
        
        triggers.forEach(trigger => {
            // Evitar duplicar listeners
            if (trigger.hasAttribute('data-initialized')) return;
            trigger.setAttribute('data-initialized', 'true');
            
            trigger.addEventListener('click', () => {
                const content = trigger.nextElementSibling as HTMLElement;
                const isOpen = content.classList.contains('is-open');
                
                // Toggle estado - CSS maneja la animación
                content.classList.toggle('is-open');
                trigger.setAttribute('aria-expanded', (!isOpen).toString());
                
                // Si se está abriendo, hacer scroll suave para mostrar el contenido
                if (!isOpen) {
                    // Esperar a que avance la animación
                    setTimeout(() => {
                        const scrollDistance = 260; // Triple de distancia para mostrar bien el contenido
                        const duration = 800; // Duración más lenta y suave
                        const start = window.pageYOffset;
                        const startTime = performance.now();
                        
                        function animateScroll(currentTime: number) {
                            const elapsed = currentTime - startTime;
                            const progress = Math.min(elapsed / duration, 1);
                            
                            // Easing suave (ease-out)
                            const easeProgress = 1 - Math.pow(1 - progress, 3);
                            
                            window.scrollTo(0, start + (scrollDistance * easeProgress));
                            
                            if (progress < 1) {
                                requestAnimationFrame(animateScroll);
                            }
                        }
                        
                        requestAnimationFrame(animateScroll);
                    }, 200); // Empezar más temprano
                }
            });
        });
    }

    // Inicializar en carga
    document.addEventListener('DOMContentLoaded', initAccordions);
    
    // Inicializar en navegación de Astro (SPA)
    document.addEventListener('astro:page-load', initAccordions);
</script>
